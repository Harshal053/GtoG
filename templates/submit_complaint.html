<!DOCTYPE html>
<html>
<head>
  <title>From Garbage to Glory</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .btn-3d {
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transform: perspective(100px) translateZ(10px);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-3d:hover {
      transform: perspective(100px) translateZ(20px) scale(1.05);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body class="container py-5">
  <nav class="mb-4">
    <a href="{{ url_for('dashboard') }}" class="btn btn-link">Dashboard</a>
    <a href="{{ url_for('submit_complaint') }}" class="btn btn-link">Submit Complaint</a>
    <a href="{{ url_for('logout') }}" class="btn btn-link">Logout</a>
  </nav>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  <h2>Submit a Complaint</h2>
  <form method="post" enctype="multipart/form-data" class="mb-3" onsubmit="return validateForm();">
    <div class="mb-3">
      <div id="map" style="height: 300px; width: 100%; margin-bottom: 10px;"></div>
      <input name="location" id="location" class="form-control" placeholder="Location" required>
      <button type="button" class="btn btn-secondary mt-2 btn-3d" onclick="getLocation()">Get Current Location</button>
    </div>
    <div class="mb-3">
      <textarea name="description" id="description" class="form-control" placeholder="Describe the issue" required></textarea>
    </div>
    <div class="mb-3">
      <input type="file" name="image" class="form-control" id="image">
    </div>
    <button type="submit" class="btn btn-primary btn-3d">Submit Complaint</button>
  </form>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script>
    var map = L.map('map').setView([20, 77], 5); // Default center (India)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    var marker;
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          document.getElementById('location').value = lat + ',' + lng;
          map.setView([lat, lng], 16);
          if (marker) { map.removeLayer(marker); }
          marker = L.marker([lat, lng]).addTo(map).bindPopup('Your Location').openPopup();
          // Fetch location name using Nominatim reverse geocoding
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
              if (data.display_name) {
                alert('Your current location is: ' + data.display_name);
                document.getElementById('location').value = data.display_name + ' (' + lat + ',' + lng + ')';
              } else {
                alert('Coordinates: ' + lat + ', ' + lng);
              }
            })
            .catch(() => {
              alert('Coordinates: ' + lat + ', ' + lng);
            });
        }, function(error) {
          alert('Unable to fetch location: ' + error.message);
        }, { enableHighAccuracy: true });
      } else {
        alert('Geolocation is not supported by this browser.');
      }
    }
    function validateForm() {
      var location = document.getElementById('location').value.trim();
      var description = document.getElementById('description').value.trim();
      var image = document.getElementById('image').value.trim();
      if (!location) {
        alert('Please enter the location.');
        return false;
      }
      if (!description) {
        alert('Please enter the description.');
        return false;
      }
      if (!image) {
        alert('Please upload an image.');
        return false;
      }
      return true;
    }
  </script>
  <footer class="mt-5 text-center text-muted">
    &copy; 2025 From Garbage to Glory. All rights reserved.<br>
    Supported by CTS OPS Team.<br>
    For queries, contact <a href="mailto:support@garbagetoglory.com">support@garbagetoglory.com</a>
  </footer>
</body>
</html>
